# External Pentesting

{% hint style="danger" %}
This is my general rough process. Each pentest is unique and does not follow a "guide". Some of these tools are loud and will get deteced. Make sure YOU understand each tools use, flags, and more when using. Some tools may cause unintendid harm if used incorrectly.
{% endhint %}

## General

* Put targets into file(targets.txt)
* NMap Targets
* OSINT with:
  * Shodan
  * Fofa
  * Censys
  * DNSDumpster
  * Ffuf
  * Nikto
  * DNSTwist
* Check if FTP is open, and if anonymous login is enabled
* Check if SSH is open and if it takes password authentication
* Look at all http/https pages for login pages or information disclosure, default logins, and test accounts.
* If Wordpress Site:
  * Run WPScan
* If OWA is open
  * Run Nikto, NMap, and CURL
* PW Spray with CredMaster from generic password list and usernames found from OneDriveUserEnum/DehashedAPITool
* Look for users and credentials on Dehashed
* Research vulnerabilities on versions of services and look for PoC
* Enumerate domain with FastGoogleDorkScan
* Enumerate users with OneDriveUserEnum
* Password Spray (use to be with CredMaster, looking into new tool, FlareProx
* Scan with Nessus

### With Credentials

* See if user can log into Azure environment
  * Enumerate for permissions and users within EntraID using portal.azure and GraphRunner
  * Crawl SharePoint for interesting files using GraphRunner
* Check other login environments
  * COMPANY.okta.com
  * m365.cloud.microsoft

## Starting

Put the target IP/Domains in a .txt file

```bash
nano targets.txt
```

## OSINT/Enumeration

### Nmap

* LDAP:

```
tmp=$(mktemp); sudo nmap --open -p 389 -iL up-hosts.txt -oG - | grep "/open" | awk '{ print $2 }' > "$tmp"; if [ -s "$tmp" ]; then mv "$tmp" 389.txt; else rm -f "$tmp"; fi
```

* HTTP:

```
tmp=$(mktemp); sudo nmap --open -p 80 -iL up-hosts.txt -oG - | grep "/open" | awk '{ print $2 }' > 80.txt"$tmp"; if [ -s "$tmp" ]; then mv "$tmp" 80.txt; else rm -f "$tmp"; fi
```

* Alt HTTP:

```
tmp=$(mktemp); sudo nmap --open -p 8080 -iL up-hosts.txt -oG - | grep "/open" | awk '{ print $2 }' > "$tmp"; if [ -s "$tmp" ]; then mv "$tmp" 8080.txt; else rm -f "$tmp"; fi
```

* HTTPS:

```
tmp=$(mktemp); sudo nmap --open -p 443 -iL up-hosts.txt -oG - | grep "/open" | awk '{ print $2 }' > "$tmp"; if [ -s "$tmp" ]; then mv "$tmp" 443.txt; else rm -f "$tmp"; fi
```

* Alt HTTPS:

```
tmp=$(mktemp); sudo nmap --open -p 8443 -iL up-hosts.txt -oG - | grep "/open" | awk '{ print $2 }' > "$tmp"; if [ -s "$tmp" ]; then mv "$tmp" 8443.txt; else rm -f "$tmp"; fi
```

* FTP:

```
tmp=$(mktemp); sudo nmap --open -p 21 -iL up-hosts.txt -oG - | grep "/open" | awk '{ print $2 }' > "$tmp"; if [ -s "$tmp" ]; then mv "$tmp" 21.txt; else rm -f "$tmp"; fi
```

* SSH:

```
tmp=$(mktemp); sudo nmap --open -p 22 -iL up-hosts.txt -oG - | grep "/open" | awk '{ print $2 }' > "$tmp"; if [ -s "$tmp" ]; then mv "$tmp" 22.txt; else rm -f "$tmp"; fi
```

```
sudo nmap -p 22 --script ssh-auth-methods -iL 22.txt
```

* RDP:

```
tmp=$(mktemp); sudo nmap --open -p 3389 -iL up-hosts.txt -oG - | grep "/open" | awk '{ print $2 }' > "$tmp"; if [ -s "$tmp" ]; then mv "$tmp" 3389.txt; else rm -f "$tmp"; fi
```

```
sudo nmap -p 3389 --script rdp-ntlm-info -iL 3389.txt > RDP-NTLM-Info.txt
```

* UDP:

```
tmp=$(mktemp); sudo nmap -Pn -sU -iL targets.txt -p 1-1024,5353,1900 -vvv -oA UDP
```

```
sudo nmap -Pn -sU -iL up-hosts.txt -p 1-1024,5353,1900 -vvv | grep "/open" | awk '{ print $2 }' > UDP.txt
```

* Scan all ports and list services, saving output

```
nmap --open -p- -Pn -sV -oA targets_65k-tcp-sV -iL targets.txt
```

### Websites:

* [Shodan](https://www.notion.so/th4ntis/shodan.io/) - Note open ports and banners
* [Fofa](https://en.fofa.info/) - Note open ports and banners
* [Web-check.xyz](https://www.notion.so/th4ntis/web-check.xyz/)
* [Censys](https://search.censys.io/)
* [DNSDumpster](https://dnsdumpster.com/) - [DNSDumpster Github](https://github.com/nmmapper/dnsdumpster)
* [DNSTwist](https://dnstwist.it/) - Note typosquatting domains

### Tools:

* [Ffuf](https://github.com/ffuf/ffuf) - will need a wordlist, such as [Seclists](https://github.com/danielmiessler/SecLists/tree/master/Discovery/Web-Content)

```bash
sudo ffuf -recursion -mc all -ac -c -e https://domain/FUZZ -w wordlist.txt
sudo ffuf -recursion -mc all -ac -c -e .htm,.shtml,.php,.html,.js,.txt,.zip,.bak,.asp,.aspx,.xml -w wordlist.txt -u https://domain/FUZZ -fc 400,401,403,404,406,500,502 > domain.txt
```

* [OneDriveUserEnum](https://github.com/nyxgeek/onedrive_user_enum) - Get the tenant name from [AAD Internals](https://aadinternals.com/osint/). Will need a wordlist, such as [Statistically Likely Usernames](https://github.com/insidetrust/statistically-likely-usernames).

```bash
sudo ./onedrive_enum.py -t tenant-name -d domain -U user-list
```

* [DeHashed-API-Tool](https://github.com/hmaverickadams/DeHashed-API-Tool)

```
dehashapitool -d DOMAIN -o Outfile.csv
```

* [Fast-Google-Dorks-Scan](https://github.com/IvanGlinkin/Fast-Google-Dorks-Scan)

```bash
sudo ./FGDS.sh domain
```

* [Sublist3r](https://github.com/aboul3la/Sublist3r)

```bash
sudo python3 sublist3r.py -d domain	
```

* [Nikto](https://github.com/sullo/nikto)

```bash
sudo nikto -h URL
```

* [Amass](https://github.com/owasp-amass/amass)

```bash
sudo amass enum -d domain
```

* [Subfinder](https://github.com/projectdiscovery/subfinder)

```bash
sudo subfinder -d domain -v
```

## Graphrunner

General Info

```
Import-Module .\GraphRunner.ps1
```

```
Get-GraphTokens # login on with URL / Code
```

```
Invoke-GraphRunner -Tokens $tokens
```

* Scan Sharepoint/OneDrive for files

```
Invoke-SearchSharePointAndOneDrive -tokens $Tokens
```

## Wordpress Sites

* `[site]/wp-admin`
* `[site]/wp-login`
* `[site]/wp-json`
* `[site]/wp-json/wp/v2/users`
* `[site]/author/[user]`
* Run [WPSCan](https://github.com/wpscanteam/wpscan)
  * This requires an [API-Token](https://wpscan.com/pricing/)

```
sudo wpscan --url URL --api-token TOKEN --enumerate vp,vt,u,tt --random-user-agent -o domain.txt
```

## OWA Sites

* Curl

```bash
curl -v -I --http1.0 https://[ip]/owa -k -H 'Location:'
curl -v -I --http1.0 https://[ip]/owa -k -H 'HEADER:'
```

* [Nikto](https://github.com/sullo/nikto)

```bash
nikto -h https://IP
```

* NMap

```bash
sudo nmap -p 443 --script http-ntlm-infp --script-args http-ntlm-info.root/ews/ IP
```

## PW Spray with [Credmaster](https://github.com/knavesec/CredMaster)

{% hint style="warning" %}
**THIS IS CURRENTLY DEPRECATED AS AMAZON HAS UPDATED IT'S** [**PENTESTING ToS**](https://aws.amazon.com/security/penetration-testing/)
{% endhint %}

* Against AzureSSO

```
python3 credmaster.py --config config.json --plugin azuresso --domain domain.com -u users.txt -p wordlist.txt --region us-east-1 --delay 20 --randomize --trim -o CLIENTNAME
```

* Against OWA

```
python3 credmaster.py --config config.json --plugin owa --domain domain.com -u users.txt -p wordlist.txt --region us-east-1 --delay 20 --randomize --trim -o CLIENTNAME
```

* Against Okta

```
python3 credmaster.py --config config.json --plugin okta --domain domain.com -u users.txt -p wordlist.txt --region us-east-1 --delay 20 --randomize --trim -o CLIENTNAME
```
